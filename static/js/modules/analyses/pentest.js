/**
 * Module d'affichage des analyses Pentest
 */

(function(window) {
    'use strict';
    
    if (!window.Formatters) {
        console.error('Module Formatters requis');
        return;
    }
    
    const { Formatters } = window;
    
    /**
     * Affiche une analyse Pentest
     * @param {Object} analysis - Données de l'analyse Pentest
     * @param {HTMLElement} container - Élément DOM où afficher les résultats
     */
    function displayPentestAnalysis(analysis, container) {
        if (!container) return;
        
        const date = new Date(analysis.date_analyse).toLocaleDateString('fr-FR', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        
        const riskScore = analysis.risk_score || 0;
        const riskColor = riskScore >= 70 ? '#e74c3c' : riskScore >= 40 ? '#f39c12' : '#27ae60';
        const riskLabel = riskScore >= 70 ? 'Élevé' : riskScore >= 40 ? 'Moyen' : 'Faible';
        
        let forms_checks = [];
        let ffuf_results = null;
        let gobuster_results = null;
        let dirsearch_results = null;
        let masscan_results = null;
        let nmap_results = null;
        
        if (analysis.pentest_details && typeof analysis.pentest_details === 'object') {
            if (Array.isArray(analysis.pentest_details.forms_checks)) {
                forms_checks = analysis.pentest_details.forms_checks;
            } else if (analysis.pentest_details.forms_checks) {
                forms_checks = [analysis.pentest_details.forms_checks];
            }
            
            ffuf_results = analysis.pentest_details.ffuf || null;
            gobuster_results = analysis.pentest_details.gobuster || null;
            dirsearch_results = analysis.pentest_details.dirsearch || null;
            masscan_results = analysis.pentest_details.masscan || null;
            nmap_results = analysis.pentest_details.nmap || null;
        }
        
        function getSeverityColor(severity) {
            if (!severity) return '#6b7280';
            const s = severity.toLowerCase();
            if (s.includes('crit') || s.includes('high')) return '#e74c3c';
            if (s.includes('medium') || s.includes('moyen')) return '#f39c12';
            if (s.includes('low') || s.includes('faible')) return '#3498db';
            return '#6b7280';
        }
        
        function formatVulnerability(vuln) {
            if (typeof vuln === 'string') {
                return `<div style="padding: 0.75rem; background: #fee; border-left: 3px solid #e74c3c; border-radius: 6px; margin-bottom: 0.5rem;">
                    <strong style="color: #c33;"><i class="fas fa-exclamation-triangle"></i></strong> ${Formatters.escapeHtml(vuln)}
                </div>`;
            }
            const name = vuln.name || vuln.title || 'Vulnérabilité inconnue';
            const severity = vuln.severity || 'Non spécifiée';
            const description = vuln.description || '';
            const recommendation = vuln.recommendation || vuln.fix || '';
            const severityColor = getSeverityColor(severity);
            
            return `<div style="padding: 1rem; background: #fff; border-left: 4px solid ${severityColor}; border-radius: 8px; margin-bottom: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <strong style="color: #2c3e50; font-size: 1rem;">${Formatters.escapeHtml(name)}</strong>
                    <span style="background: ${severityColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${Formatters.escapeHtml(severity)}</span>
                </div>
                ${description ? `<div style="color: #555; margin-bottom: 0.5rem; line-height: 1.5;">${Formatters.escapeHtml(description)}</div>` : ''}
                ${recommendation ? `<div style="background: #f0f9ff; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #3498db; margin-top: 0.5rem;">
                    <strong style="color: #1e40af; font-size: 0.85rem;"><i class="fas fa-lightbulb"></i> Recommandation:</strong>
                    <div style="color: #1e3a8a; margin-top: 0.25rem;">${Formatters.escapeHtml(recommendation)}</div>
                </div>` : ''}
            </div>`;
        }
        
        let html = `
            <div class="analysis-details" style="display: flex; flex-direction: column; gap: 1.5rem;">
                <div class="detail-section" style="background: linear-gradient(135deg, #dc2626 0%, #f59e0b 100%); color: white; padding: 1.75rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem;">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; color: white; font-size: 1.5rem;"><i class="fas fa-shield-alt"></i> Analyse de sécurité</h3>
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.95rem; opacity: 0.95;">
                                <div><strong><i class="fas fa-calendar"></i></strong> ${date}</div>
                                <div><strong><i class="fas fa-globe"></i></strong> <a href="${Formatters.escapeHtml(analysis.url)}" target="_blank" style="color: #ffd700; text-decoration: underline;">${Formatters.escapeHtml(analysis.url)}</a></div>
                                <div><strong><i class="fas fa-tag"></i></strong> ${Formatters.escapeHtml(analysis.domain || 'N/A')}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.85rem; opacity: 0.9; margin-bottom: 0.5rem;">Score de risque</div>
                            <div style="background: ${riskColor}; padding: 0.5rem 1.25rem; border-radius: 20px; font-weight: bold; font-size: 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                ${riskScore}/100
                            </div>
                            <div style="font-size: 0.85rem; margin-top: 0.25rem; opacity: 0.9;">${riskLabel}</div>
                        </div>
                    </div>
                </div>
                
                ${analysis.vulnerabilities && Array.isArray(analysis.vulnerabilities) && analysis.vulnerabilities.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-exclamation-circle" style="font-size: 1.5rem;"></i>
                        Vulnérabilités détectées
                        <span style="background: #fee; color: #c33; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.vulnerabilities.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${analysis.vulnerabilities.map(vuln => formatVulnerability(vuln)).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.security_headers && Object.keys(analysis.security_headers).length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-shield-alt" style="font-size: 1.5rem;"></i>
                        En-têtes de sécurité
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                        ${Object.entries(analysis.security_headers).map(([header, data]) => {
                            const status = data.status || (typeof data === 'string' ? data : 'present');
                            const isPresent = status === 'present' || status === 'ok' || status === 'true';
                            const statusColor = isPresent ? '#10b981' : '#ef4444';
                            const statusText = isPresent ? '<i class="fas fa-check"></i> Présent' : '<i class="fas fa-times"></i> Absent';
                            return `<div style="padding: 0.75rem; background: ${isPresent ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${statusColor}; border-radius: 6px;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${Formatters.escapeHtml(header)}</div>
                                <div style="color: ${statusColor}; font-size: 0.85rem; font-weight: 600;">${statusText}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : analysis.security_headers_analysis && Object.keys(analysis.security_headers_analysis).length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-shield-alt" style="font-size: 1.5rem;"></i>
                        En-têtes de sécurité
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.75rem;">
                        ${Object.entries(analysis.security_headers_analysis).map(([header, data]) => {
                            const status = data.status || (typeof data === 'string' ? data : 'present');
                            const isPresent = status === 'present' || status === 'ok' || status === 'true';
                            const statusColor = isPresent ? '#10b981' : '#ef4444';
                            const statusText = isPresent ? '<i class="fas fa-check"></i> Présent' : '<i class="fas fa-times"></i> Absent';
                            return `<div style="padding: 0.75rem; background: ${isPresent ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${statusColor}; border-radius: 6px;">
                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.25rem;">${Formatters.escapeHtml(header)}</div>
                                <div style="color: ${statusColor}; font-size: 0.85rem; font-weight: 600;">${statusText}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.cms_vulnerabilities && Object.keys(analysis.cms_vulnerabilities).length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 1.5rem;"></i>
                        Vulnérabilités CMS
                        <span style="background: #fee; color: #c33; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${Object.keys(analysis.cms_vulnerabilities).length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${Object.entries(analysis.cms_vulnerabilities).map(([name, vuln]) => {
                            const severity = (typeof vuln === 'object' && vuln.severity) ? vuln.severity : 'Non spécifiée';
                            const description = (typeof vuln === 'object' && vuln.description) ? vuln.description : (typeof vuln === 'string' ? vuln : '');
                            const severityColor = getSeverityColor(severity);
                            return `<div style="padding: 1rem; background: #fff; border-left: 4px solid ${severityColor}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <strong style="color: #2c3e50;">${Formatters.escapeHtml(name)}</strong>
                                    <span style="background: ${severityColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${Formatters.escapeHtml(severity)}</span>
                                </div>
                                ${description ? `<div style="color: #555; line-height: 1.5;">${Formatters.escapeHtml(description)}</div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.open_ports && Array.isArray(analysis.open_ports) && analysis.open_ports.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-globe" style="font-size: 1.5rem;"></i>
                        Ports ouverts
                        <span style="background: #f3e8ff; color: #6b21a8; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.open_ports.length}</span>
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.75rem;">
                        ${analysis.open_ports.map(port => {
                            const portNum = port.port || port;
                            const service = port.service || 'Inconnu';
                            return `<div style="padding: 0.75rem; background: #f9fafb; border-left: 3px solid #8b5cf6; border-radius: 6px;">
                                <div style="font-weight: 600; color: #1f2937;">Port ${portNum}</div>
                                <div style="color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem;">${Formatters.escapeHtml(service)}</div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${forms_checks.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-file-alt" style="font-size: 1.5rem;"></i>
                        Formulaires testés
                        <span style="background: #f0fdf4; color: #059669; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${forms_checks.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${forms_checks.map((form, idx) => {
                            const hasError = form.error;
                            const isOk = form.ok === true || form.status_code === 200;
                            const statusColor = hasError ? '#ef4444' : (isOk ? '#10b981' : '#f59e0b');
                            const statusText = hasError ? '<i class="fas fa-times"></i> Erreur' : (isOk ? '<i class="fas fa-check"></i> Accessible' : `<i class="fas fa-exclamation-triangle"></i> ${form.status_code || 'Inconnu'}`);
                            return `<div style="padding: 1rem; background: ${hasError ? '#fef2f2' : (isOk ? '#f0fdf4' : '#fffbeb')}; border-left: 4px solid ${statusColor}; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap;">
                                    <strong style="color: #1f2937;">Formulaire #${idx + 1}</strong>
                                    <span style="background: ${statusColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${statusText}</span>
                                    <span style="background: #e5e7eb; color: #4b5563; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;">${Formatters.escapeHtml(form.method || 'GET')}</span>
                                </div>
                                <div style="color: #6b7280; font-size: 0.9rem; word-break: break-all;">
                                    <strong>Action:</strong> ${Formatters.escapeHtml(form.action || 'N/A')}
                                </div>
                                ${form.status_code ? `<div style="color: #6b7280; font-size: 0.9rem; margin-top: 0.25rem;">
                                    <strong>Code HTTP:</strong> ${form.status_code}
                                </div>` : ''}
                                ${form.error ? `<div style="color: #dc2626; font-size: 0.85rem; margin-top: 0.5rem; padding: 0.5rem; background: #fee; border-radius: 4px;">
                                    <strong>Erreur:</strong> ${Formatters.escapeHtml(form.error)}
                                </div>` : ''}
                            </div>`;
                        }).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.sql_injection ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-database" style="font-size: 1.5rem;"></i>
                        Injection SQL
                    </h3>
                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                        <pre style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #374151;">${Formatters.escapeHtml(JSON.stringify(analysis.sql_injection, null, 2))}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${analysis.xss_vulnerabilities && Array.isArray(analysis.xss_vulnerabilities) && analysis.xss_vulnerabilities.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #f39c12; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-bug" style="font-size: 1.5rem;"></i>
                        Vulnérabilités XSS
                        <span style="background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.xss_vulnerabilities.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${analysis.xss_vulnerabilities.map(xss => `<div style="padding: 0.75rem; background: #fff3cd; border-left: 3px solid #f39c12; border-radius: 6px; color: #856404;">${Formatters.escapeHtml(typeof xss === 'string' ? xss : JSON.stringify(xss))}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.csrf_vulnerabilities && Array.isArray(analysis.csrf_vulnerabilities) && analysis.csrf_vulnerabilities.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #f39c12; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-exchange-alt" style="font-size: 1.5rem;"></i>
                        Vulnérabilités CSRF
                        <span style="background: #fff3cd; color: #856404; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.csrf_vulnerabilities.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${analysis.csrf_vulnerabilities.map(csrf => `<div style="padding: 0.75rem; background: #fff3cd; border-left: 3px solid #f39c12; border-radius: 6px; color: #856404;">${Formatters.escapeHtml(typeof csrf === 'string' ? csrf : JSON.stringify(csrf))}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.authentication_issues && Array.isArray(analysis.authentication_issues) && analysis.authentication_issues.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-key" style="font-size: 1.5rem;"></i>
                        Problèmes d'authentification
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.authentication_issues.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${analysis.authentication_issues.map(issue => `<div style="padding: 0.75rem; background: #dbeafe; border-left: 3px solid #3498db; border-radius: 6px; color: #1e40af;">${Formatters.escapeHtml(typeof issue === 'string' ? issue : JSON.stringify(issue))}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.authorization_issues && Array.isArray(analysis.authorization_issues) && analysis.authorization_issues.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #3498db; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-user-shield" style="font-size: 1.5rem;"></i>
                        Problèmes d'autorisation
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.authorization_issues.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${analysis.authorization_issues.map(issue => `<div style="padding: 0.75rem; background: #dbeafe; border-left: 3px solid #3498db; border-radius: 6px; color: #1e40af;">${Formatters.escapeHtml(typeof issue === 'string' ? issue : JSON.stringify(issue))}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.sensitive_data_exposure && Array.isArray(analysis.sensitive_data_exposure) && analysis.sensitive_data_exposure.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #e74c3c; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-lock" style="font-size: 1.5rem;"></i>
                        Exposition de données sensibles
                        <span style="background: #fee; color: #c33; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${analysis.sensitive_data_exposure.length}</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${analysis.sensitive_data_exposure.map(data => `<div style="padding: 0.75rem; background: #fee; border-left: 3px solid #e74c3c; border-radius: 6px; color: #c33;"><strong><i class="fas fa-exclamation-triangle"></i></strong> ${Formatters.escapeHtml(typeof data === 'string' ? data : JSON.stringify(data))}</div>`).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${analysis.ssl_tls_analysis ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-lock" style="font-size: 1.5rem;"></i>
                        Analyse SSL/TLS
                    </h3>
                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                        <pre style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #374151;">${Formatters.escapeHtml(JSON.stringify(analysis.ssl_tls_analysis, null, 2))}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${analysis.waf_detection ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-shield-alt" style="font-size: 1.5rem;"></i>
                        Détection WAF
                    </h3>
                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                        <pre style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #374151;">${Formatters.escapeHtml(JSON.stringify(analysis.waf_detection, null, 2))}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${analysis.api_security ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #06b6d4; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-plug" style="font-size: 1.5rem;"></i>
                        Sécurité API
                    </h3>
                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                        <pre style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #374151;">${Formatters.escapeHtml(JSON.stringify(analysis.api_security, null, 2))}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${analysis.network_scan && typeof analysis.network_scan === 'object' && Object.keys(analysis.network_scan).length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #6366f1; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-globe" style="font-size: 1.5rem;"></i>
                        Scan réseau
                    </h3>
                    <div style="background: #f5f5f5; padding: 1rem; border-radius: 8px; overflow-x: auto;">
                        <pre style="margin: 0; font-size: 0.85rem; line-height: 1.6; color: #374151;">${Formatters.escapeHtml(JSON.stringify(analysis.network_scan, null, 2))}</pre>
                    </div>
                </div>
                ` : ''}
                
                ${ffuf_results && !ffuf_results.error ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-search" style="font-size: 1.5rem;"></i>
                        Scan FFUF (Directory Bruteforce)
                        ${ffuf_results.vulnerabilities && ffuf_results.vulnerabilities.length > 0 ? `
                        <span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${ffuf_results.vulnerabilities.length} ressources</span>
                        ` : ''}
                    </h3>
                    ${ffuf_results.vulnerabilities && ffuf_results.vulnerabilities.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                        ${ffuf_results.vulnerabilities.slice(0, 50).map(v => `
                            <div style="padding: 0.5rem; background: #eff6ff; border-left: 3px solid #3b82f6; border-radius: 4px; font-size: 0.9rem;">
                                ${Formatters.escapeHtml(v.description || JSON.stringify(v))}
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="color: #6b7280; font-style: italic;">Aucune ressource trouvée</div>'}
                </div>
                ` : ''}
                
                ${gobuster_results && !gobuster_results.error ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-search" style="font-size: 1.5rem;"></i>
                        Scan Gobuster (Directory Bruteforce)
                        ${gobuster_results.vulnerabilities && gobuster_results.vulnerabilities.length > 0 ? `
                        <span style="background: #f3e8ff; color: #6b21a8; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${gobuster_results.vulnerabilities.length} ressources</span>
                        ` : ''}
                    </h3>
                    ${gobuster_results.vulnerabilities && gobuster_results.vulnerabilities.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                        ${gobuster_results.vulnerabilities.slice(0, 50).map(v => `
                            <div style="padding: 0.5rem; background: #faf5ff; border-left: 3px solid #8b5cf6; border-radius: 4px; font-size: 0.9rem;">
                                ${Formatters.escapeHtml(v.description || JSON.stringify(v))}
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="color: #6b7280; font-style: italic;">Aucune ressource trouvée</div>'}
                </div>
                ` : ''}
                
                ${dirsearch_results && !dirsearch_results.error ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #ec4899; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-search" style="font-size: 1.5rem;"></i>
                        Scan Dirsearch (Directory Bruteforce)
                        ${dirsearch_results.vulnerabilities && dirsearch_results.vulnerabilities.length > 0 ? `
                        <span style="background: #fce7f3; color: #9f1239; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${dirsearch_results.vulnerabilities.length} ressources</span>
                        ` : ''}
                    </h3>
                    ${dirsearch_results.vulnerabilities && dirsearch_results.vulnerabilities.length > 0 ? `
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 300px; overflow-y: auto;">
                        ${dirsearch_results.vulnerabilities.slice(0, 50).map(v => `
                            <div style="padding: 0.5rem; background: #fdf2f8; border-left: 3px solid #ec4899; border-radius: 4px; font-size: 0.9rem;">
                                ${Formatters.escapeHtml(v.description || JSON.stringify(v))}
                            </div>
                        `).join('')}
                    </div>
                    ` : '<div style="color: #6b7280; font-style: italic;">Aucune ressource trouvée</div>'}
                </div>
                ` : ''}
                
                ${masscan_results && !masscan_results.error && masscan_results.open_ports && masscan_results.open_ports.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-plug" style="font-size: 1.5rem;"></i>
                        Scan Masscan (Ports ouverts)
                        <span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${masscan_results.open_ports.length} ports</span>
                    </h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                        ${masscan_results.open_ports.map(port => `
                            <div style="background: #fef3c7; padding: 0.5rem 0.75rem; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9rem; color: #92400e; border: 1px solid #fde68a;">
                                ${port.port || port}${port.protocol ? `/${port.protocol}` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                
                ${nmap_results && nmap_results.services && nmap_results.services.length > 0 ? `
                <div class="detail-section" style="background: #fff; padding: 1.5rem; border-radius: 10px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                    <h3 style="margin: 0 0 1.25rem 0; color: #2c3e50; font-size: 1.2rem; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-search" style="font-size: 1.5rem;"></i>
                        Scan Nmap (Services détectés)
                        <span style="background: #d1fae5; color: #065f46; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 700;">${nmap_results.services.length} services</span>
                    </h3>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${nmap_results.services.map(svc => `
                            <div style="padding: 0.75rem; background: #f0fdf4; border-left: 3px solid #10b981; border-radius: 6px;">
                                <div style="font-weight: 600; color: #065f46; margin-bottom: 0.25rem;">
                                    Port ${svc.port || 'N/A'} / ${svc.protocol || 'tcp'}
                                </div>
                                ${svc.service ? `<div style="color: #047857; font-size: 0.9rem;">Service: ${Formatters.escapeHtml(svc.service)}</div>` : ''}
                                ${svc.version ? `<div style="color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem;">Version: ${Formatters.escapeHtml(svc.version)}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    // Exposer globalement
    window.PentestAnalysisDisplay = { displayPentestAnalysis };
})(window);

