# Documentation - Tâches Pentest

## Vue d'ensemble

Le module Pentest de ProspectLab permet d'effectuer des analyses de sécurité automatisées sur les sites web des entreprises. Les analyses sont exécutées de manière asynchrone via Celery et remontent leur progression en temps réel via WebSocket.

## Architecture

### Composants principaux

1. **`tasks/pentest_tasks.py`** : Tâche Celery pour l'exécution asynchrone
2. **`services/pentest_analyzer.py`** : Service d'analyse de sécurité
3. **`services/database/pentest.py`** : Gestion de la persistance des données
4. **Routes API** : Endpoints pour déclencher et consulter les analyses

### Flux d'exécution

```
Utilisateur → Route API → Celery Task → PentestAnalyzer → Base de données
                ↓              ↓              ↓
            WebSocket ← WebSocket ← Progression
```

## Tâche Celery : `pentest_analysis_task`

### Signature

```python
@celery.task(bind=True)
def pentest_analysis_task(
    self, 
    url: str, 
    entreprise_id: int = None, 
    options: Dict = None, 
    forms_from_scrapers: List[Dict[str, Any]] = None
) -> Dict
```

### Paramètres

- **`url`** (str) : URL du site à analyser
- **`entreprise_id`** (int, optional) : ID de l'entreprise associée
- **`options`** (dict, optional) : Options de scan
  - `scan_sql` : Scan SQL Injection
  - `scan_xss` : Scan XSS
  - `wpscan` : Scan WordPress
  - `nikto` : Scan général de vulnérabilités
  - `nmap_quick` : Scan réseau rapide
  - `security_headers` : Analyse des headers de sécurité
  - `ssl_tls` : Analyse SSL/TLS
- **`forms_from_scrapers`** (list, optional) : Liste des formulaires détectés par le scraper

### Retour

```python
{
    'success': True,
    'analysis_id': int,
    'url': str,
    'summary': dict,
    'risk_score': int,
    'forms_checks': list
}
```

### Progression

La tâche met à jour son état à différentes étapes :

1. **5%** : Initialisation de l'analyse Pentest
2. **25%** : Scan des vulnérabilités web
3. **90%** : Sauvegarde des résultats
4. **100%** : Analyse terminée

## Service : `PentestAnalyzer`

### Méthodes principales

#### `analyze_pentest(url, options)`

Effectue une analyse complète de sécurité.

**Options par défaut** :
- `sqlmap`: True
- `wpscan`: True
- `nikto`: True
- `wapiti`: False
- `ffuf`: True
- `gobuster`: False
- `dirsearch`: False
- `masscan`: False
- `nmap_quick`: True
- `security_headers`: True
- `ssl_tls`: True

**Retour** :
```python
{
    'url': str,
    'domain': str,
    'vulnerabilities': list,
    'sql_injection': dict,
    'xss_vulnerabilities': list,
    'csrf_vulnerabilities': list,
    'authentication_issues': list,
    'authorization_issues': list,
    'sensitive_data_exposure': list,
    'security_headers': dict,
    'ssl_tls': dict,
    'waf_detection': dict,
    'cms_vulnerabilities': dict,
    'api_security': dict,
    'risk_score': int,
    'summary': dict
}
```

#### `test_form_security(form, base_url)`

Teste la sécurité d'un formulaire détecté par le scraper.

**Paramètres** :
- `form` : Dictionnaire contenant les informations du formulaire
- `base_url` : URL de base du site

**Retour** :
```python
{
    'action': str,
    'method': str,
    'vulnerabilities': list,
    'error': str (optionnel)
}
```

### Outils supportés

Le service vérifie automatiquement la disponibilité des outils suivants :

- **sqlmap** : Injection SQL
- **wpscan** : Scan WordPress
- **nikto** : Scan général
- **wapiti** : Scan de vulnérabilités web
- **nmap** : Scan réseau
- **sslscan** : Analyse SSL/TLS
- **masscan** : Scan réseau rapide
- **ffuf** : Fuzzing web
- **gobuster** : Fuzzing de répertoires
- **dirsearch** : Fuzzing de répertoires

### Support WSL

Les outils peuvent être exécutés via WSL (Windows Subsystem for Linux) si disponibles. La configuration se fait via les variables d'environnement :

- `WSL_DISTRO` : Distribution WSL (défaut: `kali-linux`)
- `WSL_USER` : Utilisateur WSL (défaut: `loupix`)
- `PENTEST_TOOL_TIMEOUT` : Timeout des outils (défaut: `120` secondes)

## Base de données

### Tables principales

#### `analyses_pentest`

Table principale pour les analyses Pentest.

**Colonnes** :
- `id` : ID de l'analyse
- `entreprise_id` : ID de l'entreprise
- `url` : URL analysée
- `domain` : Domaine analysé
- `sql_injection` : JSON des résultats SQL Injection
- `xss_vulnerabilities` : JSON des vulnérabilités XSS
- `csrf_vulnerabilities` : JSON des vulnérabilités CSRF
- `authentication_issues` : JSON des problèmes d'authentification
- `authorization_issues` : JSON des problèmes d'autorisation
- `sensitive_data_exposure` : JSON des expositions de données sensibles
- `ssl_tls_analysis` : JSON de l'analyse SSL/TLS
- `waf_detection` : JSON de la détection WAF
- `api_security` : JSON de l'analyse API
- `network_scan` : JSON du scan réseau
- `pentest_details` : JSON des détails complets
- `risk_score` : Score de risque (0-100)
- `date_analyse` : Date de l'analyse

#### Tables normalisées

- **`analysis_pentest_vulnerabilities`** : Vulnérabilités détectées
- **`analysis_pentest_security_headers`** : Headers de sécurité
- **`analysis_pentest_cms_vulnerabilities`** : Vulnérabilités CMS
- **`analysis_pentest_open_ports`** : Ports ouverts détectés

### Gestion des données : `PentestManager`

#### `save_pentest_analysis(entreprise_id, url, pentest_data)`

Sauvegarde une analyse Pentest avec normalisation des données.

**Normalisation** :
- Vulnérabilités → Table `analysis_pentest_vulnerabilities`
- Headers de sécurité → Table `analysis_pentest_security_headers`
- Vulnérabilités CMS → Table `analysis_pentest_cms_vulnerabilities`
- Ports ouverts → Table `analysis_pentest_open_ports`

#### `get_pentest_analysis_by_entreprise(entreprise_id)`

Récupère l'analyse Pentest d'une entreprise avec données normalisées.

#### `get_pentest_analysis_by_url(url)`

Récupère une analyse Pentest par URL avec données normalisées.

#### `get_pentest_analysis(analysis_id)`

Récupère une analyse Pentest par ID avec données normalisées.

## Intégration avec le scraper

Les formulaires détectés par le scraper sont automatiquement testés pour les vulnérabilités suivantes :

- Injection SQL
- XSS (Cross-Site Scripting)
- CSRF (Cross-Site Request Forgery)
- Problèmes d'authentification
- Exposition de données sensibles

## Logging

Les logs sont enregistrés dans `logs/pentest_tasks.log` avec les niveaux suivants :

- **INFO** : Démarrage et fin d'analyse
- **DEBUG** : Détails de l'exécution (options, outils disponibles, résultats intermédiaires)
- **ERROR** : Erreurs lors de l'analyse

## Sécurité et éthique

⚠️ **Important** : Les analyses Pentest doivent uniquement être effectuées sur des sites pour lesquels vous avez une autorisation écrite. L'utilisation non autorisée de ces outils peut être illégale.

## Exemple d'utilisation

```python
from tasks.pentest_tasks import pentest_analysis_task

# Lancer une analyse
result = pentest_analysis_task.delay(
    url='https://example.com',
    entreprise_id=1,
    options={
        'scan_sql': True,
        'scan_xss': True,
        'wpscan': True,
        'security_headers': True
    },
    forms_from_scrapers=[
        {
            'action': '/login',
            'method': 'POST',
            'fields': ['username', 'password']
        }
    ]
)

# Récupérer le résultat
if result.successful():
    analysis = result.result
    print(f"Score de risque: {analysis['risk_score']}")
    print(f"ID d'analyse: {analysis['analysis_id']}")
```

## Améliorations futures

- [ ] Support de plus d'outils de pentest
- [ ] Intégration avec des bases de données de vulnérabilités (CVE)
- [ ] Génération automatique de rapports PDF
- [ ] Comparaison des analyses dans le temps
- [ ] Alertes automatiques sur nouvelles vulnérabilités critiques

