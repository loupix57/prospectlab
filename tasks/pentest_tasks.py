"""
Tâches Celery pour les analyses Pentest

Ces tâches exécutent les analyses de sécurité de manière asynchrone
et remontent la progression en temps réel.
"""

from celery_app import celery
from services.pentest_analyzer import PentestAnalyzer
from services.database import Database
from services.logging_config import setup_logger
import logging
from typing import List, Dict, Any
import requests

# Logger dédié pour les analyses Pentest (fichier séparé)
# Niveau DEBUG pour avoir un maximum de détails sans polluer les autres logs
logger = setup_logger(__name__, 'pentest_tasks.log', level=logging.DEBUG)


@celery.task(bind=True)
def pentest_analysis_task(self, url: str, entreprise_id: int = None, options: Dict = None, forms_from_scrapers: List[Dict[str, Any]] = None):
    """
    Tâche Celery pour effectuer une analyse Pentest d'un site web.

    Args:
        self: Instance de la tâche Celery (bind=True)
        url (str): URL du site à analyser
        entreprise_id (int, optional): ID de l'entreprise associée
        options (dict, optional): Options de scan (scan_sql, scan_xss, etc.)
        forms_from_scrapers (list, optional): Liste des formulaires détectés par le scraper

    Returns:
        dict: Résultats de l'analyse Pentest, incluant l'ID d'analyse et un résumé.
    """
    try:
        logger.info(f'Démarrage Pentest pour {url} (entreprise_id={entreprise_id})')
        if forms_from_scrapers:
            logger.info(f'Test de sécurité de {len(forms_from_scrapers)} formulaire(s) détecté(s)')

        self.update_state(
            state='PROGRESS',
            meta={'progress': 5, 'message': 'Initialisation de l\'analyse Pentest...'}
        )

        analyzer = PentestAnalyzer()
        opts = options or {}

        # Tester la sécurité des formulaires détectés par le scraper
        forms_checks = []
        if forms_from_scrapers:
            from urllib.parse import urlparse
            base_url_parsed = urlparse(url)
            base_url = f'{base_url_parsed.scheme}://{base_url_parsed.netloc}'
            
            for idx, form in enumerate(forms_from_scrapers, start=1):
                try:
                    form_test_result = analyzer.test_form_security(form, base_url)
                    
                    if form_test_result.get('error'):
                        continue
                    
                    # Ajouter les vulnérabilités trouvées aux résultats globaux
                    if form_test_result.get('vulnerabilities'):
                        pentest_data.setdefault('vulnerabilities', []).extend(form_test_result['vulnerabilities'])
                    
                    forms_checks.append(form_test_result)
                except Exception as form_err:
                    # Ne logger que les erreurs importantes
                    if 'No scheme supplied' not in str(form_err) and 'Invalid URL' not in str(form_err):
                        logger.warning(f'Erreur lors du test du formulaire #{idx}: {form_err}')
                    forms_checks.append({
                        'action': form.get('action') or form.get('action_url', ''),
                        'method': form.get('method', 'GET'),
                        'error': str(form_err)[:100]
                    })

        self.update_state(
            state='PROGRESS',
            meta={'progress': 25, 'message': 'Scan des vulnérabilités web...'}
        )

        pentest_data = analyzer.analyze_pentest(url, opts)
        if pentest_data.get('error'):
            raise Exception(pentest_data['error'])

        # Ajouter le résultat des tests de formulaires
        pentest_data['forms_checks'] = forms_checks

        self.update_state(
            state='PROGRESS',
            meta={'progress': 90, 'message': 'Sauvegarde des résultats...'}
        )

        database = Database()
        analysis_id = database.save_pentest_analysis(entreprise_id, url, pentest_data)

        self.update_state(
            state='PROGRESS',
            meta={'progress': 100, 'message': 'Analyse de sécurité terminée'}
        )

        logger.info(f'Analyse Pentest terminée pour {url} (id={analysis_id}, score={pentest_data.get("risk_score", 0)})')

        return {
            'success': True,
            'analysis_id': analysis_id,
            'url': url,
            'summary': pentest_data.get('summary', {}),
            'risk_score': pentest_data.get('risk_score', 0),
            'forms_checks': forms_checks
        }

    except Exception as e:
        logger.error(f'Erreur Pentest pour {url}: {e}', exc_info=True)
        raise

