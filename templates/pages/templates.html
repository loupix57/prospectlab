{% extends "base.html" %}

{% block title %}Gestion des Modèles - ProspectLab{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Gestion des modèles de messages</h1>
    <p>Créez et gérez vos modèles de prospection réutilisables</p>
</div>

<div class="templates-section">
    <button id="new-template-btn" class="btn btn-primary">Nouveau modèle</button>
    
    <div id="templates-list" class="templates-list">
        {% for template in templates %}
        <div class="template-card" data-template-id="{{ template.id }}">
            <h3>{{ template.name }}</h3>
            <p class="template-category">{{ template.category }}</p>
            <p class="template-preview">{{ template.preview or template.content[:100] }}...</p>
            <div class="template-actions">
                <button class="btn btn-small btn-edit" onclick="editTemplate('{{ template.id }}')">Modifier</button>
                <button class="btn btn-small btn-delete" onclick="deleteTemplate('{{ template.id }}')">Supprimer</button>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Modal pour créer/modifier un template -->
<div id="template-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeModal()"><i class="fas fa-times"></i></span>
        <h2 id="modal-title">Nouveau modèle</h2>
        <form id="template-form">
            <input type="hidden" id="template-id" name="template_id">
            
            <div class="form-group">
                <label for="template-name">Nom du modèle</label>
                <input type="text" id="template-name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="template-category">Catégorie</label>
                <select id="template-category" name="category">
                    <option value="cold_email">Cold Email</option>
                    <option value="linkedin">LinkedIn</option>
                    <option value="malt">Malt</option>
                    <option value="other">Autre</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="template-subject">Sujet</label>
                <input type="text" id="template-subject" name="subject" required>
            </div>
            
            <div class="form-group">
                <label for="template-content">Contenu (peut contenir {nom}, {entreprise}, {email})</label>
                <textarea id="template-content" name="content" rows="15" required></textarea>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let editingTemplateId = null;

document.getElementById('new-template-btn').addEventListener('click', function() {
    editingTemplateId = null;
    document.getElementById('modal-title').textContent = 'Nouveau modèle';
    document.getElementById('template-form').reset();
    document.getElementById('template-id').value = '';
    document.getElementById('template-modal').style.display = 'block';
});

function editTemplate(templateId) {
    editingTemplateId = templateId;
    document.getElementById('modal-title').textContent = 'Modifier le modèle';
    
    fetch(`/api/templates/${templateId}`)
        .then(response => response.json())
        .then(template => {
            document.getElementById('template-id').value = template.id;
            document.getElementById('template-name').value = template.name;
            document.getElementById('template-category').value = template.category;
            document.getElementById('template-subject').value = template.subject;
            document.getElementById('template-content').value = template.content;
            document.getElementById('template-modal').style.display = 'block';
        });
}

function deleteTemplate(templateId) {
    if (!confirm('Êtes-vous sûr de vouloir supprimer ce modèle ?')) {
        return;
    }
    
    fetch('{{ url_for("other.manage_templates") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            action: 'delete',
            template_id: templateId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        }
    });
}

function closeModal() {
    document.getElementById('template-modal').style.display = 'none';
}

document.getElementById('template-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        action: editingTemplateId ? 'update' : 'create',
        template_id: editingTemplateId,
        name: document.getElementById('template-name').value,
        category: document.getElementById('template-category').value,
        subject: document.getElementById('template-subject').value,
        content: document.getElementById('template-content').value
    };
    
    try {
        const response = await fetch('{{ url_for("other.manage_templates") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            location.reload();
        }
    } catch (error) {
        alert('Erreur : ' + error.message);
    }
});
</script>
{% endblock %}

